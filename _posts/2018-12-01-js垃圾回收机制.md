---
title: js垃圾回收机制
date: 2018-12-01 00:31:30
tags: [js]
categories: [js]
---

# JS的内存生命周期：

分配你所需要的内存
使用分配到的内存（读、写）
不需要时将其释放、归还

```
let a = 'a'; // 在内存中给变量分配空间
console.log(a); // 使用内存
a = null  // 释放内存

```

## 回收机制运行

1. 找出不在继续使用的值，释放内存空间。
2. 垃圾回收器每隔一段时间就执行一次释放操作
3. 在一次释放操作之前，通过标记清除等算法找到那些变量是不在使用的，在这次执行释放的时候执行释放。比如a=null；函数如果已经执行完毕，其内部的局部变量
4. 全局变量很难判断什么时候释放。所以要尽量避免使用全局变量。
5. js的回收机制是自动的，如何执行等一般不需要开发者关心。但是一些细节可以帮助我们写出更加优秀的代码。

## 两种算法

### 标记清楚

1. 不能释放“进入环境”的变量所占的内存，只要执行流进入相应的环境，就有可能用到他们。而当变量离开环境的时候，则将其标记为“离开环境”
2. 进行标记的方式有很多种：翻转某个特殊位来来记录一个变量何时进入环境；使用一个“进入环境”变量列表和一个“离开环境”列表；（具体实现方式了解即可）
3. 垃圾回收器在运行的时候会给所有变量都加上标记，然后，环境中的变量以及环境中的变量引用的变量，他们身上的标记会被去掉。
4. 而在此之后再被加上标记的变量将被视为准备删除的变量，原因是环境中的变量已经无法访问到这些变量了。
5. 最后，垃圾收集器完成内存清除工作，销毁那些带标记的值并回收它们所占用的内存空间。

### 引用计数
跟踪记录每个值被引用的次数。

1. 当声明了一个变量，并将一个引用类型值赋值给该变量时，则这个值的引用次数就是1。
2. 如果同一个值又被赋给另外一个变量，则该值得引用次数加1。
3. 相反，如果包含对这个值引用的变量又取得了另外一个值，则这个值的引用次数减 1。
4. 当这个值的引用次数变成 0时，则说明没有办法再访问这个值了，因而就可以将其占用的内存空间回收回来。
5. 这样，当垃圾收集器下次再运行时，它就会释放那 些引用次数为零的值所占用的内存。


## 日常使用注意事项


### 变量和DOM之间的引用
避免这样的引用。如果有，记得及时重置。
```
obj = {};
obj.el = $('#div');
```

### 全局变量

慎用，谨慎管理

### 闭包引起的内存泄漏


原因：闭包可以维持函数内局部变量，使其得不到释放。
解决：不用闭包，复杂的基础函数谨慎使用；或者在定义事件处理函数的外部函数中，删除对dom的引用。

### 对象属性对DOM的引用

### 定时器

### 子元素存在引用引起的内存泄漏

