---
title: js的单线程与异步
date: 2018-04-09 00:31:30
tags: [js]
categories: [js]
---

JavaScript语言的一大特点就是单线程，也就是说，同一个时间只能做一件事。为什么呢？与它的用途有关。作为浏览器脚本语言，JavaScript的主要用途是与用户互动，以及操作DOM。那如果进程阻塞了怎么办呢 ？js语言的假性'异步'使得js高效的运行。


## 浏览器与脚本JS

js是单线程语言，浏览器只分配给js一个主线程，用来执行任务（函数），但一次只能执行一个任务，这些任务形成一个任务队列排队等候执行。但前端的某些任务是非常耗时的，比如网络请求，定时器和事件监听，如果让他们和别的任务一样，都老老实实的排队等待执行的话，执行效率会非常的低，甚至导致页面的假死。所以，浏览器为这些耗时任务开辟了另外的线程，主要包括http请求线程，浏览器定时触发器，浏览器事件触发线程，这些任务是异步的。

## 主线程与任务队列
上图：
<img src="{{ site.imgurl }}/normal/jsdxc.png">

主线程从"任务队列"中读取事件，这个过程是循环不断的，所以整个的这种运行机制又称为Event Loop（事件循环）。

我们把刚才了解的概念和图中做一个对应，浏览器为异步任务单独开辟的线程可以统一理解为WebAPIs，任务队列就是callback queue，我们所说的主线程就是有虚线组成的那一部分，堆（heap）和栈（stack）共同组成了js主线程，函数的执行就是通过进栈和出栈实现的，比如图中有一个foo()函数，主线程把它推入栈中，在执行函数体时，发现还需要执行上面的那几个函数，所以又把这几个函数推入栈中，等到函数执行完，就让函数出栈。等到stack清空时，说明一个任务已经执行完了，这时就会从callback queue中寻找下一个人任务推入栈中。

## 举个例子

```
setTimeout(function(){
	console.log(1);
}, 50)

```
执行这段代码的时候，浏览器异步执行计时操作，当50ms到了后，会触发定时事件，这个时候，就会把回调函数放到任务队列里。整个程序就是通过这样的一个个事件驱动起来的。

其实js一直是单线程的，浏览器才是异步的实现者。

## H5中的'多线程'

为了利用多核CPU的计算能力，HTML5提出Web Worker标准，允许JavaScript脚本创建多个线程，但是子线程完全受主线程控制，且不得操作DOM。所以，这个新标准并没有改变JavaScript单线程的本质。